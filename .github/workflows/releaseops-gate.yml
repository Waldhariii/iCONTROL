name: ReleaseOps Gate

on:
  workflow_dispatch: {}
  pull_request:
    branches: [ "main" ]
  push:
    branches: [ "main" ]

concurrency:
  group: releaseops-gate-${{ github.ref }}
  cancel-in-progress: true

jobs:
  gate:
    runs-on: ubuntu-latest
    timeout-minutes: 15
    env:
      CI: "1"

    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: "20"
          cache: "pnpm"
          cache-dependency-path: |
            pnpm-lock.yaml
            app/pnpm-lock.yaml

      - name: Install pnpm (if needed)
        run: |
          set -euo pipefail
          if command -v pnpm >/dev/null 2>&1; then
            pnpm -v
          else
            corepack enable
            corepack prepare pnpm@latest --activate
            pnpm -v
          fi

      - name: Install deps (root)
        run: |
          set -euo pipefail
          if [[ -f pnpm-lock.yaml ]]; then
            pnpm install --frozen-lockfile
          elif [[ -f package-lock.json ]]; then
            npm ci
          else
            npm install
          fi

      - name: Install deps (app) if isolated
        run: |
          set -euo pipefail
          if [[ -d app ]]; then
            cd app
            if [[ -f pnpm-lock.yaml ]]; then
              pnpm install --frozen-lockfile
            elif [[ -f package-lock.json ]]; then
              npm ci
            elif [[ -f package.json ]]; then
              npm install
            fi
          fi

      - name: Zsh syntax check (publish)
        run: |
          set -euo pipefail
          zsh -n scripts/release/publish.zsh

      - name: ReleaseOps Gate (publish.zsh dry-run; offline governance)
        run: |
          set -euo pipefail
          chmod +x ./scripts/release/publish.zsh || true
          ./scripts/release/publish.zsh TAG=v0.2.0-tools999 --prerelease --dry-run --scope "CI ReleaseOps Gate"

      - name: Upload artifacts (always)
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: releaseops-gate-artifacts
          path: |
            **/_RELEASE_NOTES_*.md
            /tmp/*.log
          if-no-files-found: ignore
