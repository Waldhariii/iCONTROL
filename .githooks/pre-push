#!/usr/bin/env bash
set -euo pipefail

# ============================================
# SSOT PRE-PUSH GATE (SCOPED)
# - Default (feature branches): APP SSOT preflight (fast)
# - main/master OR SSOT_PUSH_STRICT=1: full gate:ssot (root)
# ============================================

REPO_ROOT="$(git rev-parse --show-toplevel)"
APP_DIR="${REPO_ROOT}/app"

if [[ ! -d "$APP_DIR" ]]; then
  echo "[pre-push] ERROR: app workspace not found at: $APP_DIR"
  exit 1
fi

# Determine remote targets from stdin (git pre-push contract)
# stdin lines: <local_ref> <local_sha> <remote_ref> <remote_sha>
STRICT=0
while read -r local_ref local_sha remote_ref remote_sha; do
  case "$remote_ref" in
    refs/heads/main|refs/heads/master) STRICT=1 ;;
  esac
done || true

if [[ "${SSOT_PUSH_STRICT:-0}" == "1" ]]; then
  STRICT=1
fi

if [[ "$STRICT" == "1" ]]; then
  echo "[pre-push] STRICT mode: running root gate:ssot (main/master or SSOT_PUSH_STRICT=1)"
  npm run -s gate:ssot
  echo "[pre-push] PASS (gate:ssot)"
  exit 0
fi

echo "[pre-push] FAST mode: running app preflight (verify:ssot:fast)"
cd "$APP_DIR"
npm run -s preflight
echo "[pre-push] PASS (preflight)"
